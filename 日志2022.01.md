# 2022.01.09

# Docker学习

Docker的安装文档：https://docs.docker.com/get-started/

docker-ce 社区版docker

启动docker
> sudo systemctl start docker 

docker version 查看是否安装成功

测试hello world
> sudo docker run hello-world

查看已安装的镜像 
> docker images 

docker帮助命令
>docker version 显示docker的版本信息
>docker info    显示docker的系统信息，更详细 
>docker 命令 --help

docker的所有指令 https://docs.docker.com/reference/

## 镜像命令

docker images 查看所有镜像

```shell
root@tom:/home/tom# docker images
REPOSITORY           TAG       IMAGE ID       CREATED       SIZE
tensorflow/serving   1.13.1    a1e1ff37f1c7   2 years ago   206MB
tensorflow/serving   latest    048f8669e211   2 years ago   214MB
hello-world          latest    fce289e99eb9   3 years ago   1.84kB

# 解释
REPOSITORY  镜像的仓库源/名字
TAG         镜像的标签
IMAGE ID    镜像的id
CREATED     镜像创建的时间
SIZE        镜像的大小

# 可选项

    -a --all    #列出所有镜像
    -q --quiet  #只显示镜像的id

```
docker hub: https://hub.docker.com/

docker search 搜索命令

```shell
root@tom:/home/tom# docker search mysql
NAME                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
mysql                             MySQL is a widely used, open-source relation…   11940     [OK]       
mariadb                           MariaDB Server is a high performing open sou…   4562      [OK]       
mysql/mysql-server                Optimized MySQL Server Docker images. Create…   896                  [OK]
phpmyadmin                        phpMyAdmin - A web interface for MySQL and M…   419       [OK]  

# 可选项，
 --filter=STARS=3000 #搜索收藏数不低于3000的镜像
```

docker pull 下载镜像
```shell
# docker pull 镜像名字[:tag]
root@tom:/home/tom# docker pull mysql   
Using default tag: latest   # 如果不写 tag，默认使 latest
latest: Pulling from library/mysql
72a69066d2fe: Pull complete     # 分层下载，docker image的核心，联合文件系统
93619dbc5b36: Pull complete 
99da31dd6142: Pull complete 
626033c43d70: Pull complete 
37d5d7efb64e: Pull complete 
ac563158d721: Pull complete 
d2ba16033dad: Pull complete 
688ba7d5c01a: Pull complete 
00e060b6d11d: Pull complete 
1c04857f594f: Pull complete 
4d7cfa90e6ea: Pull complete 
e0431212d27d: Pull complete 
Digest: sha256:e9027fe4d91c0153429607251656806cc784e914937271037f7738bd5b8e7709 # 签名
Status: Downloaded newer image for mysql:latest
docker.io/library/mysql:latest  # 真实地址
# docker pull mysql 等价于 docker pull docker.io/library/mysql:latest

# 指定版本下载
root@tom:/home/tom# docker pull mysql:5.7
5.7: Pulling from library/mysql
72a69066d2fe: Already exists 
93619dbc5b36: Already exists 
99da31dd6142: Already exists 
626033c43d70: Already exists 
37d5d7efb64e: Already exists 
ac563158d721: Already exists 
d2ba16033dad: Already exists 
0ceb82207cd7: Pull complete 
37f2405cae96: Pull complete 
e2482e017e53: Pull complete 
70deed891d42: Pull complete 
Digest: sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94
Status: Downloaded newer image for mysql:5.7
docker.io/library/mysql:5.7
```

docker rmi 删除镜像
```shell
root@tom:/home/tom# docker rmi -f 镜像id # 删除指定的镜像
root@tom:/home/tom# docker rmi -f 镜像id1 镜像id2 镜像id3 # 删除多个镜像
root@tom:/home/tom# docker rmi -f $(docker images -aq) #删除全部指令，$(docker images -aq)可以搜索全部镜像的id
```
## 容器命令

有了镜像才能创建容器，以centos为例

```shell
docker pull centos 
root@tom:/home/tom# docker pull ubuntu
```
### 新建容器并启动

```shell
docker run [可选参数] imagesID

# 参数说明
--name="Name"   建立的容器的名字，用来区分容器
-d              后台运行方式
-it             使用交互方式运行，进入容器查看内容
-p              指定容器的端口 -p 8080:8080
    -p 主机端口：容器端口
    -p 容器端口
    容器端口
    -p ip:主机端口:容器端口
-P              随机指定端口

# 测试，启动并加入容器
root@tom:/home/tom# docker run -it ubuntu /bin/bash
root@531b74ff3ee5:/# ls # 查看容器内的文件
bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var 

# 从容器中退出
root@531b74ff3ee5:/# exit
exit

```

### 列出所有运行的容器

```shell
# docker ps 命令
    # 列出当前正在运行的容器
-a  # 列出当前正在运行的容器+历史运行过的容器
-n=?    #显示最近创建的？个容器
-q  # 只显示容器的编号

root@tom:/home/tom# docker ps
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES

root@tom:/home/tom# docker ps -a
CONTAINER ID   IMAGE                COMMAND                  CREATED         STATUS                          PORTS                              NAMES
531b74ff3ee5   ubuntu               "/bin/bash"              3 minutes ago   Exited (0) About a minute ago                                      angry_heisenberg
0483ac9695b9   hello-world          "/hello"                 17 hours ago    Exited (0) 17 hours ago                                            exciting_joliot
```
### 退出容器

```shell
exit    # 直接停止容器并退出
Ctrl+P+Q    #容器不停止，退出
```

### 删除容器

```shell
docker rm 容器id    # 删除指定容器，不能删除正在运行的容器，强制删除 -f
docker rm $(docker ps -aq)  # 删除所有容器
docker ps -a -q|xargs docker rm # 删除所有容器
```
### 启动和停止容器

```shell
docker start 容器id     # 启动
docker restart 容器id   # 重启
docker stop 容器id      # 停止
docker kill 容器id      # 强制停止容器
```

## 常用的其他命令

### 后台启动容器

```shell
# 命令 docker run -d 镜像名
root@tom:/home/tom# docker run -d ubuntu
# 问题：使用docker ps发现ubuntu停止了
# 常见的坑：docker容器使用后台运行，就必须有一个前台进程，docker发现没有应用，就会自动停止
```
### 查看日志

```shell
docker logs -f -t --tail 日志数量 容器id #没有日志
# 编写一个脚本，让容器一直运行
root@tom:/home/tom# docker run -d ubuntu /bin/sh -c "while true;do echo mmm;sleep 1;done"

root@tom:/home/tom# docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES
916d0f7cfe4b   ubuntu    "/bin/sh -c 'while t…"   5 seconds ago   Up 4 seconds             modest_moor

# 显示日志
    -t  #显示日志
    -f  #显示时间戳
    --tail number   # 显示日志条数
root@tom:/home/tom# docker logs -f -t --tail 10 916d0f7cfe4b
```

### 查看容器中进程的信息

```shell
# 命令 docker top 容器id
root@tom:/home/tom# docker top 916d0f7cfe4b
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                19243               19209               0                   15:59               ?                   00:00:00            /bin/sh -c while true;do echo mmm;sleep 1;done
root                19872               19243               0                   16:04               ?                   00:00:00            sleep 1
```
### 查看镜像的源数据

```shell
# 命令 docker inspect 容器id
root@tom:/home/tom# docker inspect 916d0f7cfe4b
[
    {
        "Id": "916d0f7cfe4be9ed294d4354057a58cef64481efd66ba9a176c38020f8aa3c9f",
        "Created": "2022-01-10T07:59:12.000439739Z",
        "Path": "/bin/sh",
        "Args": [
            "-c",
            "while true;do echo mmm;sleep 1;done"
        ],
        "State": {
            "Status": "running",
            "Running": true,
            "Paused": false,
            "Restarting": false,
            "OOMKilled": false,
            "Dead": false,
            "Pid": 19243,
            "ExitCode": 0,
            "Error": "",
            "StartedAt": "2022-01-10T07:59:12.718429414Z",
            "FinishedAt": "0001-01-01T00:00:00Z"
        },
        "Image": "sha256:d13c942271d66cb0954c3ba93e143cd253421fe0772b8bed32c4c0077a546d4d",
        "ResolvConfPath": "/var/lib/docker/containers/916d0f7cfe4be9ed294d4354057a58cef64481efd66ba9a176c38020f8aa3c9f/resolv.conf",
        "HostnamePath": "/var/lib/docker/containers/916d0f7cfe4be9ed294d4354057a58cef64481efd66ba9a176c38020f8aa3c9f/hostname",
        "HostsPath": "/var/lib/docker/containers/916d0f7cfe4be9ed294d4354057a58cef64481efd66ba9a176c38020f8aa3c9f/hosts",
        "LogPath": "/var/lib/docker/containers/916d0f7cfe4be9ed294d4354057a58cef64481efd66ba9a176c38020f8aa3c9f/916d0f7cfe4be9ed294d4354057a58cef64481efd66ba9a176c38020f8aa3c9f-json.log",
        "Name": "/modest_moore",
        "RestartCount": 0,
        "Driver": "overlay2",
        "Platform": "linux",
        "MountLabel": "",
        "ProcessLabel": "",
        "AppArmorProfile": "docker-default",
        "ExecIDs": null,
        "HostConfig": {
            "Binds": null,
            "ContainerIDFile": "",
            "LogConfig": {
                "Type": "json-file",
                "Config": {}
            },
            "NetworkMode": "default",
            "PortBindings": {},
            "RestartPolicy": {
                "Name": "no",
                "MaximumRetryCount": 0
            },
            "AutoRemove": false,
            "VolumeDriver": "",
            "VolumesFrom": null,
            "CapAdd": null,
            "CapDrop": null,
            "CgroupnsMode": "host",
            "Dns": [],
            "DnsOptions": [],
            "DnsSearch": [],
            "ExtraHosts": null,
            "GroupAdd": null,
            "IpcMode": "private",
            "Cgroup": "",
            "Links": null,
            "OomScoreAdj": 0,
            "PidMode": "",
            "Privileged": false,
            "PublishAllPorts": false,
            "ReadonlyRootfs": false,
            "SecurityOpt": null,
            "UTSMode": "",
            "UsernsMode": "",
            "ShmSize": 67108864,
            "Runtime": "runc",
            "ConsoleSize": [
                0,
                0
            ],
            "Isolation": "",
            "CpuShares": 0,
            "Memory": 0,
            "NanoCpus": 0,
            "CgroupParent": "",
            "BlkioWeight": 0,
            "BlkioWeightDevice": [],
            "BlkioDeviceReadBps": null,
            "BlkioDeviceWriteBps": null,
            "BlkioDeviceReadIOps": null,
            "BlkioDeviceWriteIOps": null,
            "CpuPeriod": 0,
            "CpuQuota": 0,
            "CpuRealtimePeriod": 0,
            "CpuRealtimeRuntime": 0,
            "CpusetCpus": "",
            "CpusetMems": "",
            "Devices": [],
            "DeviceCgroupRules": null,
            "DeviceRequests": null,
            "KernelMemory": 0,
            "KernelMemoryTCP": 0,
            "MemoryReservation": 0,
            "MemorySwap": 0,
            "MemorySwappiness": null,
            "OomKillDisable": false,
            "PidsLimit": null,
            "Ulimits": null,
            "CpuCount": 0,
            "CpuPercent": 0,
            "IOMaximumIOps": 0,
            "IOMaximumBandwidth": 0,
            "MaskedPaths": [
                "/proc/asound",
                "/proc/acpi",
                "/proc/kcore",
                "/proc/keys",
                "/proc/latency_stats",
                "/proc/timer_list",
                "/proc/timer_stats",
                "/proc/sched_debug",
                "/proc/scsi",
                "/sys/firmware"
            ],
            "ReadonlyPaths": [
                "/proc/bus",
                "/proc/fs",
                "/proc/irq",
                "/proc/sys",
                "/proc/sysrq-trigger"
            ]
        },
        "GraphDriver": {
            "Data": {
                "LowerDir": "/var/lib/docker/overlay2/75dff48ce7c9e6931a9733c98ce6159fbe69b8dffd26bee04127fd2c1e2e100a-init/diff:/var/lib/docker/overlay2/759ad84cabbef8506082a5afe831afe9a0e26eb5963fc2af151baf8bbc9c303a/diff",
                "MergedDir": "/var/lib/docker/overlay2/75dff48ce7c9e6931a9733c98ce6159fbe69b8dffd26bee04127fd2c1e2e100a/merged",
                "UpperDir": "/var/lib/docker/overlay2/75dff48ce7c9e6931a9733c98ce6159fbe69b8dffd26bee04127fd2c1e2e100a/diff",
                "WorkDir": "/var/lib/docker/overlay2/75dff48ce7c9e6931a9733c98ce6159fbe69b8dffd26bee04127fd2c1e2e100a/work"
            },
            "Name": "overlay2"
        },
        "Mounts": [],
        "Config": {
            "Hostname": "916d0f7cfe4b",
            "Domainname": "",
            "User": "",
            "AttachStdin": false,
            "AttachStdout": false,
            "AttachStderr": false,
            "Tty": false,
            "OpenStdin": false,
            "StdinOnce": false,
            "Env": [
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
            ],
            "Cmd": [
                "/bin/sh",
                "-c",
                "while true;do echo mmm;sleep 1;done"
            ],
            "Image": "ubuntu",
            "Volumes": null,
            "WorkingDir": "",
            "Entrypoint": null,
            "OnBuild": null,
            "Labels": {}
        },
        "NetworkSettings": {
            "Bridge": "",
            "SandboxID": "24113e95cd028e73b5fc9c5db2ef90f457028a266a7d65e88b32b380c04207cb",
            "HairpinMode": false,
            "LinkLocalIPv6Address": "",
            "LinkLocalIPv6PrefixLen": 0,
            "Ports": {},
            "SandboxKey": "/var/run/docker/netns/24113e95cd02",
            "SecondaryIPAddresses": null,
            "SecondaryIPv6Addresses": null,
            "EndpointID": "90e95c1c96dd5667347fab3539e2f5809857d4d20fd6929a57e08e0e221f591e",
            "Gateway": "172.17.0.1",
            "GlobalIPv6Address": "",
            "GlobalIPv6PrefixLen": 0,
            "IPAddress": "172.17.0.2",
            "IPPrefixLen": 16,
            "IPv6Gateway": "",
            "MacAddress": "02:42:ac:11:00:02",
            "Networks": {
                "bridge": {
                    "IPAMConfig": null,
                    "Links": null,
                    "Aliases": null,
                    "NetworkID": "483469c75d25ed0a84ce31f95d0dab33abf88a4d30b01a73b15c10be58f949c7",
                    "EndpointID": "90e95c1c96dd5667347fab3539e2f5809857d4d20fd6929a57e08e0e221f591e",
                    "Gateway": "172.17.0.1",
                    "IPAddress": "172.17.0.2",
                    "IPPrefixLen": 16,
                    "IPv6Gateway": "",
                    "GlobalIPv6Address": "",
                    "GlobalIPv6PrefixLen": 0,
                    "MacAddress": "02:42:ac:11:00:02",
                    "DriverOpts": null
                }
            }
        }
    }
]
```

### 进入正在运行的容器

```shell
# 容器通常后台运行，需要进入容器修改配置
# 命令 
docker exec -it 容器id bashShell    # 开启一个新终端
# 测试
root@tom:/home/tom# docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES
916d0f7cfe4b   ubuntu    "/bin/sh -c 'while t…"   10 minutes ago   Up 10 minutes             modest_moore
root@tom:/home/tom# docker exec -it 916d0f7cfe4b /bin/bash
root@916d0f7cfe4b:/# ps -df
UID        PID  PPID  C STIME TTY          TIME CMD
root       674     1  0 08:10 ?        00:00:00 sleep 1
root       675   654  0 08:10 pts/0    00:00:00 ps -df
root@916d0f7cfe4b:/# ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 07:59 ?        00:00:00 /bin/sh -c while true;do echo mmm;sleep 1;done
root       654     0  0 08:09 pts/0    00:00:00 /bin/bash
root       679     1  0 08:10 ?        00:00:00 sleep 1
root       680   654  0 08:10 pts/0    00:00:00 ps -ef

# 方式二，进入正在运行的终端，不会启动新进程
docker attach 容器id
```
### 从容器拷贝文件到主机

```shell
docker cp 容器id:容器内文件的路径 主机文件夹路径

root@tom:/home/tom# docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES
916d0f7cfe4b   ubuntu    "/bin/sh -c 'while t…"   21 minutes ago   Up 21 minutes             modest_moore
root@tom:/home/tom# docker exec -it 916d0f7cfe4b /bin/bash
root@916d0f7cfe4b:/# cd /home
root@916d0f7cfe4b:/home# ls
root@916d0f7cfe4b:/home# touch test.cpp
root@916d0f7cfe4b:/home# exit
exit
root@tom:/home/tom# docker cp 916d0f7cfe4b:/home/test.cpp /home/tom/
root@tom:/home/tom# ls | grep test
opencvtest
test.cpp
test.yaml

# 拷贝是一个手动的过程，后期可以使用 -v 卷的技术，实现数据自动同步
```
## 小结

<img src="https://raw.githubusercontent.com/simoonp/picture/main/docker/docker.jpg" alt="Image" style="zoom:100%;" />

### 作业

> 作业1 docker安装nginx

```shell
# 1、搜索镜像 search，可以去docker hub上搜索
# 2、下载镜像 pull
# 3、运行测试

# -d 后台运行
# --name 容器命名
# -p 服务器/宿主机端口:容器内部端口 映射端口
root@tom:/home/tom# docker run -d --name nginx01 -p 3344:80 nginx
4c8887c9b9013d7f18f0fc8e05aeeaee3ac6d7516f066331915f5604c0682653
root@tom:/home/tom# docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                                   NAMES
4c8887c9b901   nginx     "/docker-entrypoint.…"   7 seconds ago   Up 6 seconds   0.0.0.0:3344->80/tcp, :::3344->80/tcp   nginx01
916d0f7cfe4b   ubuntu    "/bin/sh -c 'while t…"   3 hours ago     Up 3 hours                                             modest_moore
```

> 作业2 docker安装tomcat
```shell
# 官方的使用
docker run -it --rm tomcat:9.0
# --rm 参数 在容器运行完后会自动删除
# 当停掉tomcat后，容器就没了

docker pull tomcat:9.0

docker run -d -p 3355:8080 --name tomcat01 tomcat
# 访问没有问题，但没有内容，但官方下载的是阉割版本的
```
![Images](https://raw.githubusercontent.com/simoonp/picture/main/docker/tomcat01.png)
```shell
# 从终端进入tomcat01
root@tom:/home/tom# docker exec -it tomcat01 /bin/bash
root@e0335f9ea8b6:/usr/local/tomcat# cd /usr/local/tomcat/webapps
root@e0335f9ea8b6:/usr/local/tomcat/webapps# ls
root@e0335f9ea8b6:/usr/local/tomcat/webapps# 
# 问题1：Linux命令少了
# 问题2：没有webapps
# 默认是最小镜像，阉割了好多东西，webapps文件夹里的东西在webapps.list里面
```

> 作业3 部署es + kibana

```shell
# es 暴漏的端口多；十分耗内存；数据一般需要放置到安全目录，要挂载
# https://hub.docker.com/_/elasticsearch
$ docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" elasticsearch:tag
# --net somenetwork 是网络配置，暂时不用
$ docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" elasticsearch:7.16.2

# 很占内存！！！ docker stats 查看CPU的状态，占了8G的内存
CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O        PIDS
4655ddc8dcb5   elasticsearch   1.22%     8.366GiB / 15.61GiB   53.60%    22.3kB / 1.98kB   85.7MB / 778kB   89
e0335f9ea8b6   tomcat01        0.13%     240MiB / 15.61GiB     1.50%     170kB / 126kB     340kB / 0B       43
4c8887c9b901   nginx01         0.00%     28.67MiB / 15.61GiB   0.18%     267kB / 3.68kB    0B / 8.19kB      33
916d0f7cfe4b   modest_moore    0.16%     9.629MiB / 15.61GiB   0.06%     348kB / 0B        193kB / 0B       2

# 访问测试
root@tom:/home/tom# curl localhost:9200
{
  "name" : "4655ddc8dcb5",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "v9Dd4MNZTU-YA1SmmGGq-w",
  "version" : {
    "number" : "7.16.2",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "2b937c44140b6559905130a8650c64dbd0879cfb",
    "build_date" : "2021-12-18T19:42:46.604893745Z",
    "build_snapshot" : false,
    "lucene_version" : "8.10.1",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}

# 关闭 es
root@tom:/home/tom# docker stop 4655ddc8dcb5

# 新建容器，增加内存限制，修改配置文件， -e 参数 环境配置修改
$ docker run -d --name elasticsearch02 -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" -e ES_JAVA_OPTS="-Xms64m -Xmx512m" elasticsearch:7.16.2

CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O          BLOCK I/O       PIDS
7fe1e4e51920   elasticsearch02   53.84%    562.4MiB / 15.61GiB   3.52%     7.63MB / 122kB   15.4MB / 16MB   101
e0335f9ea8b6   tomcat01          0.15%     240.1MiB / 15.61GiB   1.50%     208kB / 126kB    422kB / 0B      43
4c8887c9b901   nginx01           0.00%     28.67MiB / 15.61GiB   0.18%     304kB / 3.68kB   0B / 8.19kB     33
916d0f7cfe4b   modest_moore      0.18%     9.672MiB / 15.61GiB   0.06%     385kB / 0B       193kB / 0B      2
```

### 可视化

- portainer
```shell
docker run -d -p 8088:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock --privileged=true portainer/portainer
```
- Rancher(CI/CD再用)

### 什么是portainer？

Docker图形化管理界面！提供一个后台面板
```shell
root@tom:/home/tom# docker run -d -p 8088:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock --privileged=true portainer/portainer

root@tom:/home/tom# docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED             STATUS             PORTS                                                                                  NAMES
2b65a0ca08fe   portainer/portainer    "/portainer"             31 seconds ago      Up 30 seconds      0.0.0.0:8088->9000/tcp, :::8088->9000/tcp                                              inspiring_swirles
7fe1e4e51920   elasticsearch:7.16.2   "/bin/tini -- /usr/l…"   12 minutes ago      Up 12 minutes      0.0.0.0:9200->9200/tcp, :::9200->9200/tcp, 0.0.0.0:9300->9300/tcp, :::9300->9300/tcp   elasticsearch02
e0335f9ea8b6   tomcat                 "catalina.sh run"        51 minutes ago      Up 51 minutes      0.0.0.0:3355->8080/tcp, :::3355->8080/tcp                                              tomcat01
4c8887c9b901   nginx                  "/docker-entrypoint.…"   About an hour ago   Up About an hour   0.0.0.0:3344->80/tcp, :::3344->80/tcp                                                  nginx01
916d0f7cfe4b   ubuntu                 "/bin/sh -c 'while t…"   4 hours ago         Up 4 hours                                                                                                modest_moore

```
测试：访问8088

![Images](https://raw.githubusercontent.com/simoonp/picture/main/docker/portainer.png)

![Images](https://raw.githubusercontent.com/simoonp/picture/main/docker/portainer02.png)

## commit镜像

```shell
docker commit 提交容器成为一个新的副本

# 与git命令类似
docker commit -m="提交的描述信息" -a="作者名" 容器ID 目标镜像名:[tag]
```

实战测试
```shell
# 之前的tomcat已经移动过文件了，把这个容器做成镜像
root@tom:/home/tom# docker commit -a="Simoonp" -m="tomcat commit test" e0335f9ea8b6 tomcat02:1.0
sha256:b3272ce7d6f23a950a96d4ab758f8e39dea4d03b1162368772a84db041d925bc
root@tom:/home/tom# docker images
REPOSITORY            TAG       IMAGE ID       CREATED         SIZE
tomcat02              1.0       b3272ce7d6f2   6 seconds ago   684MB
ubuntu                latest    d13c942271d6   3 days ago      72.8MB
nginx                 latest    605c77e624dd   11 days ago     141MB
tomcat                9.0       b8e65a4d736d   2 weeks ago     680MB
tomcat                latest    fb5657adc892   2 weeks ago     680MB
mysql                 latest    3218b38490ce   2 weeks ago     516MB
elasticsearch         7.16.2    66c29cde15ce   3 weeks ago     646MB
centos                latest    5d0da3dc9764   3 months ago    231MB
# 以后就可以使用自己修改的镜像
```
---
# 2021.01.10

## 容器数据卷

**什么是容器数据卷**

数据不能在容器中，否则容器一删除数据就没了---->需求：数据持久化

容器之间可以有一个数据共享的技术，docker容器产生的数据同步到本地

将容器的目录挂载到Linux上

**容器的持久化和同步操作！容器间是可以数据共享的**

### 使用数据卷

> 方式一：直接使用命令挂载 -v

```shell
# 将docker目录挂载到本地
docker run -it -v 主机目录:容器目录 容器id

root@tom:/home/tom# docker run -it -v /home/test:/home  ubuntu /bin/bash

root@tom:/home# ls
admint  hadoop  test  tom

root@tom:/home/test# touch  test

root@c0469f3b3efb:/home# ls
test
```

### 具名和匿名挂载

```shell

# 匿名挂载
-v 容器内路径！
root@tom:/home/tom# docker run -d -P --name nginx02 -v /etc/nginx nginx
81d7c24ee67e74aa5876b6a1bb8adf60696b4177cf0dc7c63b2ad3202e792af9

#查看所有 卷volume 的情况
# docker volume
root@tom:/home/tom# docker volume ls
DRIVER    VOLUME NAME
local     2ff21beb15c08dc9b01c94474b1c51b6012c4d34944aef8924d3671a468e779e
local     b03e763a0113849c6c814031e15c6fdfe2126ed89f5a4952ac6f938cf84bdb2a
# 这就是匿名挂载，卷名是一长串字符

# 具名挂载
root@tom:/home/tom# docker run -d -P --name nginx03 -v juming-nginx:/etc/nginx nginx
8339878d6ca701f70232e40c820fcf3e4a8ac9105b82058556a2f9af8d7320f0
root@tom:/home/tom# docker volume ls
DRIVER    VOLUME NAME
local     2ff21beb15c08dc9b01c94474b1c51b6012c4d34944aef8924d3671a468e779e
local     b03e763a0113849c6c814031e15c6fdfe2126ed89f5a4952ac6f938cf84bdb2a
local     juming-nginx
# 通过 -v 卷名:容器内路径
# 查看
root@tom:/home/tom# docker volume inspect juming-nginx
[
    {
        "CreatedAt": "2022-01-11T09:05:07+08:00",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/juming-nginx/_data",
        "Name": "juming-nginx",
        "Options": null,
        "Scope": "local"
    }
]
```
所有docker容器内的卷，在没有指定目录的情况下都是在`/var/lib/docker/volumes/卷名/_data`下

通过具名挂载，可以方便找到我们的一个卷，大多数使用`具名挂载`

```shell
# 如何区分具名、匿名挂载，还是指定目录挂载
-v 容器内路径   # 匿名
-v 卷名:容器内路径  #具名
-v /宿主机路径:容器内路径   #指定路径
```

拓展：
```shell
# 通过 -v 容器内路径:ro/rw 改变读写权限
ro  #只读，在容器内不能更改内容，只能从宿主机修改
rw  #可读可写
```

### 初识DockerFile

DockerFile是也用来构建docker镜像的构建文件，是命令脚本

通过脚本可以生成镜像，镜像是一层一层的，每个命令都是一层
```shell
root@tom:/home/docker-test-volume# vim dockerfile1
# 内容：
FROM ubuntu
VOLUME ["volum01","volume02"]
CMD echo "----end----"
CMD /bin/bash 

------

root@tom:/home/docker-test-volume# docker build -f dockerfile1 -t simoonp/ubuntu:1.0 .
Sending build context to Docker daemon  2.048kB
Step 1/4 : FROM ubuntu
 ---> d13c942271d6
Step 2/4 : VOLUME ["volum01","volume02"]
 ---> Running in 723140abfec0
Removing intermediate container 723140abfec0
 ---> 50f51a41977b
Step 3/4 : CMD echo "----end----"
 ---> Running in ee8dc31d8a70
Removing intermediate container ee8dc31d8a70
 ---> 289247e05bc0
Step 4/4 : CMD /bin/bash
 ---> Running in d8822445d1a7
Removing intermediate container d8822445d1a7
 ---> 2ef973c35e1f
Successfully built 2ef973c35e1f
Successfully tagged simoonp/ubuntu:1.0

root@tom:/home/docker-test-volume# docker images
REPOSITORY            TAG       IMAGE ID       CREATED          SIZE
simoonp/ubuntu        1.0       2ef973c35e1f   45 seconds ago   72.8MB
tomcat02              1.0       b3272ce7d6f2   13 hours ago     684MB
ubuntu                latest    d13c942271d6   3 days ago       72.8MB

# 报错：
root@tom:/home/docker-test-volume# docker run -it 2ef973c35e1f /bin/bash
docker: Error response from daemon: OCI runtime create failed: invalid mount {Destination:volume02 Type:bind Source:/var/lib/docker/volumes/100ade31deec17abe4581a36f6c17e393d86368cac9f1cb46321a3e0b59b5327/_data Options:[rbind]}: mount destination volume02 not absolute: unknown.
ERRO[0000] error waiting for container: context canceled 
# 解决： 修改 dockerfile1 将卷改成绝对路径
FROM ubuntu
VOLUME ["/volum01","/volume02"]
CMD echo "----end----"
CMD /bin/bash 

root@tom:/home/docker-test-volume# docker build -f dockerfile1 -t simoonp/ubuntu:1.0 .
Sending build context to Docker daemon  2.048kB
Step 1/4 : FROM ubuntu
 ---> d13c942271d6
Step 2/4 : VOLUME ["/volum01","/volume02"]
 ---> Running in 815470b4aff8
Removing intermediate container 815470b4aff8
 ---> d32de186387a
Step 3/4 : CMD echo "----end----"
 ---> Running in 02501b3a149a
Removing intermediate container 02501b3a149a
 ---> be74f0df39d9
Step 4/4 : CMD /bin/bash
 ---> Running in 06557be146b9
Removing intermediate container 06557be146b9
 ---> 3a839f93974e
Successfully built 3a839f93974e
Successfully tagged simoonp/ubuntu:1.0
root@tom:/home/docker-test-volume# docker images
REPOSITORY       TAG       IMAGE ID       CREATED          SIZE
simoonp/ubuntu   1.0       3a839f93974e   10 seconds ago   72.8MB
ubuntu           latest    d13c942271d6   3 days ago       72.8MB
root@tom:/home/docker-test-volume# docker run -it 3a839f93974e /bin/bash
root@fb3770f5c91e:/# ls
bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volum01  volume02
```
这里生成的卷是匿挂载
```shell
# 查看容器信息
root@tom:/home# docker inspect fb3770f5c91e
        "Mounts": [
            {
                "Type": "volume",
                "Name": "26effe6f8dd715e96d3a1ced45202389bba628192ae389003c4c059a62b17237",
                "Source": "/var/lib/docker/volumes/26effe6f8dd715e96d3a1ced45202389bba628192ae389003c4c059a62b17237/_data",
                "Destination": "/volum01",
                "Driver": "local",
                "Mode": "",
                "RW": true,
                "Propagation": ""
            },
            {
                "Type": "volume",
                "Name": "0d1332bdfd9460ad0380d913e2b512bd7f1795628dfad5067a196ac357c1767b",
                "Source": "/var/lib/docker/volumes/0d1332bdfd9460ad0380d913e2b512bd7f1795628dfad5067a196ac357c1767b/_data",
                "Destination": "/volume02",
                "Driver": "local",
                "Mode": "",
                "RW": true,
                "Propagation": ""
            }
        ],
root@4231fe4bb65c:/# cd volum01/
root@4231fe4bb65c:/volum01# touch tmcp
root@tom:/var/lib/docker/volumes/26effe6f8dd715e96d3a1ced45202389bba628192ae389003c4c059a62b17237/_data# ls
tmcp
```
### 数据卷容器

两个/多个容器之间实现数据共享

```shell
# 启动三个容器
# 启动docker01
root@tom:/home# docker images
REPOSITORY       TAG       IMAGE ID       CREATED          SIZE
simoonp/ubuntu   1.0       3a839f93974e   41 minutes ago   72.8MB
ubuntu           latest    d13c942271d6   4 days ago       72.8MB
root@tom:/home# docker run -it --name docker01 simoonp/ubuntu:1.0
root@cd308d45f604:/# ls
bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volum01  volume02

root@tom:/home/tom# docker ps
CONTAINER ID   IMAGE                COMMAND                  CREATED          STATUS          PORTS     NAMES
cd308d45f604   simoonp/ubuntu:1.0   "/bin/sh -c /bin/bash"   47 seconds ago   Up 46 seconds             docker01

# 启动docker02，并挂载docker01   --volumes-from
root@tom:/home/tom# docker run -it --name docker02 --volumes-from docker01 simoonp/ubuntu:1.0
root@cf23da6acc45:/# ls
bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volum01  volume02

# 在docker01里面添加文件
root@cd308d45f604:/# cd volum01/
root@cd308d45f604:/volum01# touch made_by_docker01
root@cd308d45f604:/volum01# 
# 在docker02里面查看
root@cf23da6acc45:/volum01# ls
made_by_docker01
# docker01创建的内容同步到了docker02
# 通过 --volumes-from docker02继承了docker01的卷
# 即使删除了容器docker01，docker02依然可以访问卷volum01等其他卷
```
## DockerFile

构建步骤：
1、构建 dockerfile 文件

2、docker build 构建成为一个镜像

3、docker run 运行镜像

4、docker push 发布镜像（DockerHub、阿里云镜像仓库等）

好多官方包都是基础包，阉割了不少功能

### DockerFile构建过程

**基础知识**：

1、每个保留关键字(指令)都必须是大写字母

2、执行是从上到下的顺序

3、# 表示注释

4、每一个指令都会创建提交一个新的镜像层

dockerfile是面向开发的，发布项目，做镜像就需要编写dockerfile文件

DockerFile：构建文件，定义了一切步骤，源代码

DockerImage：通过DockerFile构建生成镜像，最终发布的

Docker容器：容器就是镜像运行起来提供服务器

```shell
FROM		# 基础镜像，一切从这里开始
MAINTAINER	# 镜像是谁写的，姓名+邮箱
RUN			# 镜像构建是需要的命令
ADD			# 步骤：tomcat容器，这个tomcat压缩包，就是要添加的内容
WORKDIR		# 镜像的工作目录
VOLUME		# 挂载的目录
EXPOSE		# 指定暴漏的端口，端口配置
CMD			# 指定这个容器启动是要执行的指令，只有CMD的最后一个指令会生效
ENTRYPOINT	# 指定这个容器启动是要执行的指令，可以追加命令
ONBIUILD	# 当构建一个被继承的DockerFile，这是就会运行ONBUILD
COPY		# 类似ADD，将文件拷贝到镜像中
ENV			# 构建时设置环境变量
```

### 实战测试

Docker Hub中99%的镜像都是从 FROM scratch 构建的，然后再次基础上增加配置

> 创建自己的Ubuntu

```shell
# 1、编写DockerFile文件
root@tom:/home/tom/dockerfile# cat dockerfile-ubuntu 
FROM ubuntu

MAINTAINER simoonp<simoonp@outlook.com>

ENV MYPATH /usr/local
WORKDIR $MYPATH
RUN apt-get update
RUN apt-get -y install vim
RUN apt-get -y install net-tools

EXPOSE 80

CMD echo $MYPATH
CMD echo "---ebd---"
CMD /bin/bash

# 2、通过文件构建镜像
# 命令： docker build -f dockerfile文件路径 -t 镜像名:[tag] 镜像存放路径
docker build -f dockerfile-ubuntu -t mybuntu:1.0 .
# 构建完成后的提示
Successfully built f90c2201ad45
Successfully tagged mybuntu:1.0

root@tom:/home/tom/dockerfile# docker images
REPOSITORY       TAG       IMAGE ID       CREATED         SIZE
mybuntu          1.0       f90c2201ad45   3 minutes ago   175MB
simoonp/ubuntu   1.0       3a839f93974e   2 hours ago     72.8MB
ubuntu           latest    d13c942271d6   4 days ago      72.8MB

# 运行测试
root@tom:/home/tom/dockerfile# docker run -it mybuntu:1.0
root@156a47eee2ad:/usr/local# pwd
/usr/local
root@156a47eee2ad:/usr/local# ifconfig 
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.17.0.4  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:ac:11:00:04  txqueuelen 0  (Ethernet)
        RX packets 42  bytes 11076 (11.0 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

root@156a47eee2ad:/usr/local# vim
root@156a47eee2ad:/usr/local# 
```

自己新建的镜像相比与官方的，多了自己加的配置

列出本地镜像的变更历史 docker history

```shell
root@tom:/home/tom# docker images
REPOSITORY       TAG       IMAGE ID       CREATED         SIZE
mybuntu          1.0       f90c2201ad45   7 minutes ago   175MB
simoonp/ubuntu   1.0       3a839f93974e   2 hours ago     72.8MB
ubuntu           latest    d13c942271d6   4 days ago      72.8MB
root@tom:/home/tom# docker history f90c2201ad45
IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT
f90c2201ad45   7 minutes ago    /bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "/bin…   0B        
2c2d3cc7735a   7 minutes ago    /bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "echo…   0B        
cdf19a1548f4   7 minutes ago    /bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "echo…   0B        
357b36b00625   7 minutes ago    /bin/sh -c #(nop)  EXPOSE 80                    0B        
5195e9869fc2   8 minutes ago    /bin/sh -c apt-get -y install net-tools         1.52MB    
4b4154d0f73a   8 minutes ago    /bin/sh -c apt-get -y install vim               68.2MB    
2bc495fc30ec   8 minutes ago    /bin/sh -c apt-get update                       32.7MB    
c233e4305e5d   10 minutes ago   /bin/sh -c #(nop) WORKDIR /usr/local            0B        
d1be04928cd6   10 minutes ago   /bin/sh -c #(nop)  ENV MYPATH=/usr/local        0B        
0f64562c12c6   10 minutes ago   /bin/sh -c #(nop)  MAINTAINER simoonp<simoon…   0B        
d13c942271d6   4 days ago       /bin/sh -c #(nop)  CMD ["bash"]                 0B        
<missing>      4 days ago       /bin/sh -c #(nop) ADD file:122ad323412c2e70b…   72.8MB  
```

可以看到镜像的构建过程

> CMD 和 ENTRYPOINT 的区别

测试CMD

```shell
# 编写dockerfile文件
root@tom:/home/tom/dockerfile# vim dockerfile-cmd
root@tom:/home/tom/dockerfile# cat dockerfile-cmd 
FROM ubuntu
CMD ["ls","-a"]

# 构建镜像
root@tom:/home/tom/dockerfile# docker build -f dockerfile-cmd -t cmdtest .
Sending build context to Docker daemon  3.072kB
Step 1/2 : FROM ubuntu
 ---> d13c942271d6
Step 2/2 : CMD ["ls","-a"]
 ---> Running in 51cc69548c58
Removing intermediate container 51cc69548c58
 ---> fafa7d0e5e09
Successfully built fafa7d0e5e09
Successfully tagged cmdtest:latest

# 运行测试
root@tom:/home/tom/dockerfile# docker run fafa7d0e5e09
.
..
.dockerenv
bin
boot
dev
etc
home
lib
lib32
lib64
libx32
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var

# 追加命令
root@tom:/home/tom/dockerfile# docker run fafa7d0e5e09 -l
docker: Error response from daemon: OCI runtime create failed: container_linux.go:380: starting container process caused: exec: "-l": executable file not found in $PATH: unknown.
ERRO[0001] error waiting for container: context canceled 
```

测试 ENTRYPOINT

```shell
# 编写dockerfile
root@tom:/home/tom/dockerfile# vim dockerfile-entrypoint
root@tom:/home/tom/dockerfile# cat dockerfile-entrypoint 
FROM ubuntu
ENTRYPOINT ["ls","-a"]

# 构建镜像
root@tom:/home/tom/dockerfile# docker build -f dockerfile-entrypoint -t entrypointtest .
Sending build context to Docker daemon  4.096kB
Step 1/2 : FROM ubuntu
 ---> d13c942271d6
Step 2/2 : ENTRYPOINT ["ls","-a"]
 ---> Running in bd2bc3f16782
Removing intermediate container bd2bc3f16782
 ---> 301ffb6404aa
Successfully built 301ffb6404aa
Successfully tagged entrypointtest:latest

# 运行容器
root@tom:/home/tom/dockerfile# docker run 301ffb6404aa
.
..
.dockerenv
bin
boot
dev
etc
home
lib
lib32
lib64
libx32
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var

# 追加命令
root@tom:/home/tom/dockerfile# docker run 301ffb6404aa -l
total 56
drwxr-xr-x   1 root root 4096 Jan 11 07:55 .
drwxr-xr-x   1 root root 4096 Jan 11 07:55 ..
-rwxr-xr-x   1 root root    0 Jan 11 07:55 .dockerenv
lrwxrwxrwx   1 root root    7 Jan  5 16:47 bin -> usr/bin
drwxr-xr-x   2 root root 4096 Apr 15  2020 boot
drwxr-xr-x   5 root root  340 Jan 11 07:55 dev
drwxr-xr-x   1 root root 4096 Jan 11 07:55 etc
drwxr-xr-x   2 root root 4096 Apr 15  2020 home
lrwxrwxrwx   1 root root    7 Jan  5 16:47 lib -> usr/lib
lrwxrwxrwx   1 root root    9 Jan  5 16:47 lib32 -> usr/lib32
lrwxrwxrwx   1 root root    9 Jan  5 16:47 lib64 -> usr/lib64
lrwxrwxrwx   1 root root   10 Jan  5 16:47 libx32 -> usr/libx32
drwxr-xr-x   2 root root 4096 Jan  5 16:47 media
drwxr-xr-x   2 root root 4096 Jan  5 16:47 mnt
drwxr-xr-x   2 root root 4096 Jan  5 16:47 opt
dr-xr-xr-x 710 root root    0 Jan 11 07:55 proc
drwx------   2 root root 4096 Jan  5 16:50 root
drwxr-xr-x   5 root root 4096 Jan  5 16:50 run
lrwxrwxrwx   1 root root    8 Jan  5 16:47 sbin -> usr/sbin
drwxr-xr-x   2 root root 4096 Jan  5 16:47 srv
dr-xr-xr-x  13 root root    0 Jan 11 01:49 sys
drwxrwxrwt   2 root root 4096 Jan  5 16:50 tmp
drwxr-xr-x  13 root root 4096 Jan  5 16:47 usr
drwxr-xr-x  11 root root 4096 Jan  5 16:50 var
```

### 实战：Tomcat镜像

1、在服务器上准备镜像文件 tomcat 压缩包，jdk的压缩包

https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.56/bin/apache-tomcat-9.0.56.tar.gz

https://media.githubusercontent.com/media/stevezhouht/jdk-8u11-linux-x64.tar.gz/master/jdk-8u11-linux-x64.tar.gz

2、编写 dockerfile 文件，文件密码为 `Dockerfiile` ，build的时候会自动找这个文件

```shell
# 在tomcat 压缩包，jdk的压缩包所在路径编写
root@tom:/home/tom/dockerfile/tomcat# ls
apache-tomcat-9.0.56.tar.gz  Dockerfile  jdk-8u11-linux-x64.tar.gz  readme.txt

root@tom:/home/tom/dockerfile# vim Dockerfile
root@tom:/home/tom/dockerfile# cat Dockerfile
FROM centos
MAINTAINER simoonp<simoonp@outlook.com>

COPY readme.txt /usr/local/readme.txt

# ADD命令会自动解压
ADD jdk-8u11-linux-x64.tar.gz /usr/local/
ADD apache-tomcat-9.0.56.tar.gz /usr/local

RUN yum -y install vim

ENV MYPATH /usr/local
WORKDIR $MYPATH

ENV JAVA_HOME /usr/local/jdk1.8.0_11
ENV CLASSPATH $JAVA_HOME/lib/dt,jar:$JAVA_HOME/lib/tools.jar
ENV CATALINA_HOME /usr/local/apache-tomcat-9.0.56
ENV CATALINA_BASH /usr/local/apache-tomcat-9.0.56
ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_BASH/bin

EXPOSE 8080

CMD /usr/local/apache-tomcat-9.0.56/bin/startup.sh && tail -F /url/local/apache-tomcat-9.0.56/bin/logs/catalina.out
```

3、构建镜像

```shell
# docker build -t diytomcat .
root@tom:/home/tom/dockerfile/tomcat# docker build -t diytomcat .
Sending build context to Docker daemon  170.6MB
Step 1/15 : FROM centos
 ---> 5d0da3dc9764
Step 2/15 : MAINTAINER simoonp<simoonp@outlook.com>
 ---> Running in 4093e1ecda5d
Removing intermediate container 4093e1ecda5d
 ---> 26dfe69fed36
Step 3/15 : COPY readme.txt /usr/local/readme.txt
 ---> 42caec8b22c3
Step 4/15 : ADD jdk-8u11-linux-x64.tar.gz /usr/local/
 ---> 03d8f3678392
Step 5/15 : ADD apache-tomcat-9.0.56.tar.gz /usr/local
 ---> b9c274a52fc8
Step 6/15 : RUN yum -y install vim
 ---> Running in 6dba0646afa3
CentOS Linux 8 - AppStream                      1.5 MB/s | 8.4 MB     00:05    
CentOS Linux 8 - BaseOS                         1.2 MB/s | 4.6 MB     00:03    
CentOS Linux 8 - Extras                         6.1 kB/s |  10 kB     00:01    
Dependencies resolved.
================================================================================
 Package             Arch        Version                   Repository      Size
================================================================================
Installing:
 vim-enhanced        x86_64      2:8.0.1763-16.el8         appstream      1.4 M
Installing dependencies:
 gpm-libs            x86_64      1.20.7-17.el8             appstream       39 k
 vim-common          x86_64      2:8.0.1763-16.el8         appstream      6.3 M
 vim-filesystem      noarch      2:8.0.1763-16.el8         appstream       49 k
 which               x86_64      2.21-16.el8               baseos          49 k

Transaction Summary
================================================================================
Install  5 Packages

Total download size: 7.8 M
Installed size: 30 M
Downloading Packages:
(1/5): gpm-libs-1.20.7-17.el8.x86_64.rpm         37 kB/s |  39 kB     00:01    
(2/5): vim-filesystem-8.0.1763-16.el8.noarch.rp  52 kB/s |  49 kB     00:00    
(3/5): vim-enhanced-8.0.1763-16.el8.x86_64.rpm  582 kB/s | 1.4 MB     00:02    
(4/5): which-2.21-16.el8.x86_64.rpm              94 kB/s |  49 kB     00:00    
(5/5): vim-common-8.0.1763-16.el8.x86_64.rpm    915 kB/s | 6.3 MB     00:07    
--------------------------------------------------------------------------------
Total                                           906 kB/s | 7.8 MB     00:08     
warning: /var/cache/dnf/appstream-02e86d1c976ab532/packages/gpm-libs-1.20.7-17.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY
CentOS Linux 8 - AppStream                      1.6 MB/s | 1.6 kB     00:00    
Importing GPG key 0x8483C65D:
 Userid     : "CentOS (CentOS Official Signing Key) <security@centos.org>"
 Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D
 From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
Key imported successfully
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                        1/1 
  Installing       : which-2.21-16.el8.x86_64                               1/5 
  Installing       : vim-filesystem-2:8.0.1763-16.el8.noarch                2/5 
  Installing       : vim-common-2:8.0.1763-16.el8.x86_64                    3/5 
  Installing       : gpm-libs-1.20.7-17.el8.x86_64                          4/5 
  Running scriptlet: gpm-libs-1.20.7-17.el8.x86_64                          4/5 
  Installing       : vim-enhanced-2:8.0.1763-16.el8.x86_64                  5/5 
  Running scriptlet: vim-enhanced-2:8.0.1763-16.el8.x86_64                  5/5 
  Running scriptlet: vim-common-2:8.0.1763-16.el8.x86_64                    5/5 
  Verifying        : gpm-libs-1.20.7-17.el8.x86_64                          1/5 
  Verifying        : vim-common-2:8.0.1763-16.el8.x86_64                    2/5 
  Verifying        : vim-enhanced-2:8.0.1763-16.el8.x86_64                  3/5 
  Verifying        : vim-filesystem-2:8.0.1763-16.el8.noarch                4/5 
  Verifying        : which-2.21-16.el8.x86_64                               5/5 

Installed:
  gpm-libs-1.20.7-17.el8.x86_64         vim-common-2:8.0.1763-16.el8.x86_64    
  vim-enhanced-2:8.0.1763-16.el8.x86_64 vim-filesystem-2:8.0.1763-16.el8.noarch
  which-2.21-16.el8.x86_64             

Complete!
Removing intermediate container 6dba0646afa3
 ---> 3ae311d8f985
Step 7/15 : ENV MYPATH /usr/local
 ---> Running in 83899b7e24f1
Removing intermediate container 83899b7e24f1
 ---> f9e6c5cbd04d
Step 8/15 : WORKDIR $MYPATH
 ---> Running in 76411afac875
Removing intermediate container 76411afac875
 ---> bc1ddca44934
Step 9/15 : ENV JAVA_HOME /usr/local/jdk1.8.0_11
 ---> Running in aa7e003a08c3
Removing intermediate container aa7e003a08c3
 ---> 893bff2a7a60
Step 10/15 : ENV CLASSPATH $JAVA_HOME/lib/dt,jar:$JAVA_HOME/lib/tools.jar
 ---> Running in 66677a20b0c4
Removing intermediate container 66677a20b0c4
 ---> 873549b0e06d
Step 11/15 : ENV CATALINA_HOME /usr/local/apache-tomcat-9.0.56
 ---> Running in 741ac2190e27
Removing intermediate container 741ac2190e27
 ---> b4865e0dcf20
Step 12/15 : ENV CATALINA_BASH /usr/local/apache-tomcat-9.0.56
 ---> Running in a9a666a265c4
Removing intermediate container a9a666a265c4
 ---> 0c090331628e
Step 13/15 : ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_BASH/bin
 ---> Running in 6b77e910208c
Removing intermediate container 6b77e910208c
 ---> b38318b3f114
Step 14/15 : EXPOSE 8080
 ---> Running in 6f1cea6d019d
Removing intermediate container 6f1cea6d019d
 ---> 3733d5c6a8cb
Step 15/15 : CMD /usr/local/apache-tomcat-9.0.56/bin/startup.sh && tail -F /url/local/apache-tomcat-9.0.56/bin/logs/catalina.out
 ---> Running in 1f4992aebcd4
Removing intermediate container 1f4992aebcd4
 ---> 01859b478e74
Successfully built 01859b478e74
Successfully tagged diytomcat:latest

root@tom:/home/tom/dockerfile/tomcat# docker images
REPOSITORY       TAG       IMAGE ID       CREATED             SIZE
diytomcat        latest    01859b478e74   3 minutes ago       638MB
entrypointtest   latest    301ffb6404aa   About an hour ago   72.8MB
cmdtest          latest    fafa7d0e5e09   3 hours ago         72.8MB
mybuntu          1.0       f90c2201ad45   6 hours ago         175MB
```

4、测试运行

```shell
root@tom:/home/tom/dockerfile/tomcat# docker run -d -p 9090:8080 --name simoonptomcat -v /home/tom/dockerfile/tomcat/test:/usr/local/apache-tomcat-9.0.56/webapps/test -v /home/tom/dockerfile/tomcat/tomcatlogs:/usr/local/apache-tomcat-9.0.56/logs diytomcat

root@tom:/home/tom/dockerfile/tomcat# docker exec -it eb8305ddc5e4522dcc /bin/bash
[root@eb8305ddc5e4 local]# ls
apache-tomcat-9.0.56  bin  etc  games  include  jdk1.8.0_11  lib  lib64  libexec  readme.txt  sbin  share  src
[root@eb8305ddc5e4 local]# cd apache-tomcat-9.0.56/
[root@eb8305ddc5e4 apache-tomcat-9.0.56]# ls 
BUILDING.txt  CONTRIBUTING.md  LICENSE  NOTICE  README.md  RELEASE-NOTES  RUNNING.txt  bin  conf  lib  logs  temp  webapps  work

# 在浏览器里输入 http://localhost:9090/ 可以访问
```

![diytomcat01](https://raw.githubusercontent.com/simoonp/picture/main/docker/diytomcat01.png)

5、发布项目

```shell
root@tom:/home/tom/dockerfile/tomcat# pwd
/home/tom/dockerfile/tomcat
root@tom:/home/tom/dockerfile/tomcat# ls
apache-tomcat-9.0.56.tar.gz  Dockerfile  jdk-8u11-linux-x64.tar.gz  readme.txt  test  tomcatlogs
root@tom:/home/tom/dockerfile/tomcat# cd test/
root@tom:/home/tom/dockerfile/tomcat/test# ls
root@tom:/home/tom/dockerfile/tomcat/test# mkdir WEB-INF
root@tom:/home/tom/dockerfile/tomcat/test# ls
WEB-INF
root@tom:/home/tom/dockerfile/tomcat/test# cd WEB-INF/

root@tom:/home/tom/dockerfile/tomcat/test/WEB-INF# vim web.xml
root@tom:/home/tom/dockerfile/tomcat/test/WEB-INF# cat web.xml 
<?xml version="1.0" encoding="UTF-8"?>
<web-app version="2.4" 
    xmlns="http://java.sun.com/xml/ns/j2ee" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee 
        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd">
</web-app>

root@tom:/home/tom/dockerfile/tomcat/test/WEB-INF# cd ..
root@tom:/home/tom/dockerfile/tomcat/test# ls
WEB-INF
root@tom:/home/tom/dockerfile/tomcat/test# vim index.jsp
root@tom:/home/tom/dockerfile/tomcat/test# cat index.jsp 
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<html>
<head>
    <title>Hello World - JSP</title>
</head>
<body>
    <%-- JSP Comment --%>
    <h1>Hello World!</h1>
    <p>
    <%
         out.println("Your IP address is ");
    %>
    <span style="color:red">
        <%= request.getRemoteAddr() %>
    </span>
    </p>
<%
System.out.println("---my test web logs----");
%>
</body>
</html>
```

![diytomcat02](https://raw.githubusercontent.com/simoonp/picture/main/docker/diytomcat02.png)

查看日志

```shell
root@tom:/home/tom/dockerfile/tomcat/tomcatlogs# cat catalina.out 

...
---my test web logs----
---my test web logs----
# 访问网站后就会出现 ---my test web logs----
```

### 发布镜像

> 发布到Docker Hub

1、在 https://hub.docker.com/ 注册账号

2、确定账号可以登录

3、提交自己的镜像

```shell
# docker login 登录账号
docker login -u 用户名
```

4、登录后就可以提交镜像

```shell
# 给镜像增加标签
docker tag 镜像id 新镜像名:[tag] # 镜像名：用户名/名字

docker push 新镜像名:[tag]
# 直接push会被拒绝
```

提交的时候也是按照镜像的层级来提交的

> 发布阿里云镜像服务上

1、登录阿里云

2、找到容器镜像服务

3、创建命名空间

4、创建容器镜像

### 小结

![docker_summary](https://raw.githubusercontent.com/simoonp/picture/main/docker/docker_summary.png)

## Docker网络

### 理解 Docker0 网络

![docker_net](https://raw.githubusercontent.com/simoonp/picture/main/docker/docker_net.png)

```shell
# 问题： docker如何处理容器之间网络的访问

# 启动容器
root@tom:/home/tom# docker run -d -P --name tomcat01 tomcat
# 查看容器的网络
# 容器启动后，输入ip显示： bash: ip: command not found
# 进入容器 安装 iproute2
root@tom:/home/tom# docker exec -it tomcat01 /bin/bash
root@750312d95723:/usr/local/tomcat# apt-get update
root@750312d95723:/usr/local/tomcat# apt-get install -y iproute2
root@750312d95723:/usr/local/tomcat# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
79: eth0@if80: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever

# 宿主机可以通过 eth0@if80 ping通容器
root@tom:/home/tom# ping 172.17.0.2
PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.
64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.088 ms
64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.086 ms
64 bytes from 172.17.0.2: icmp_seq=3 ttl=64 time=0.082 ms
```

> 原理

1、每启动一个容器，docker都会为容器分配ip，只要安装了docker，就会与一个网卡docker0

docker0使用的时桥接模式，用的是 veth-pair 技术

2、宿主机再次 ip addr 会多一个网卡

```shell
80: veth6bcc25d@if79: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master docker0 state UP group default 
    link/ether 86:67:a6:cf:07:c9 brd ff:ff:ff:ff:ff:ff link-netnsid 1
    inet6 fe80::8467:a6ff:fecf:7c9/64 scope link 
       valid_lft forever preferred_lft forever
```

容器带来的网卡都是一对一对的

veth-pair 就是一对虚拟设备接口，总是成对出现，一端连接协议，一端连接彼此

3、容器之间可以通过 docker0 互相ping通

所有容器不知道网络的话，默认是指向 docker0

Docker 使用的是Linux桥接，宿主机中是一个Docker容器的网桥 docker0

容器移除后，宿主机中的相关网卡自动消失

### --link

```shell
# 容器之间不能直接用容器名互相ping通
root@tom:/home/tom# docker run -d -P --name tomcat02 tomcat

root@tom:/home/tom# docker exec -it tomcat01 ping tomcat02
ping: tomcat02: Name or service not known
# 注，若tomcat中没有ping指令，可以通过 apt install -y iputils-ping 安装

# 借助 --link， tomcat03 可以ping tomcat01
root@tom:/home/tom# docker exec -it tomcat03 ping tomcat01
PING tomcat01 (172.17.0.2) 56(84) bytes of data.
64 bytes from tomcat01 (172.17.0.2): icmp_seq=1 ttl=64 time=0.102 ms
64 bytes from tomcat01 (172.17.0.2): icmp_seq=2 ttl=64 time=0.102 ms
# 但是 tomcat01 不能ping tomcat03
root@tom:/home/tom# docker exec -it tomcat01 ping tomcat03
ping: tomcat03: Name or service not known
```

查看host3

```shell
root@tom:/home/tom# docker exec -it tomcat03 cat /etc/hosts
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.17.0.2      tomcat01 750312d95723
172.17.0.4      98742826f914
# tomcat03绑定了tomcat01

root@tom:/home/tom# docker exec -it tomcat02 cat /etc/hosts
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.17.0.3      55a5da7ffdd1
```

不推荐使用 --link

自定义网络，不适用docker0

docker0不支持容器名访问

### 自定义网络

```shell
# 查看所有 docker 网络
# docker network ls
root@tom:/home/tom# docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
483469c75d25   bridge    bridge    local
ef23768f459b   host      host      local
20f6fa85d5be   none      null      local
```

**网络模式**

bridge：桥接（m默认）

none：不配置网络

host：和宿主机共享网络

container：容器间联通（用的少，局限大）

**测试**

```shell
# 启动容器的时候，默认加了 --net bridge
docker run -d -P --name tomcat01 tomcat
#等价于 
docker run -d -P --name tomcat01 --net bridge tomcat

# docker0特点：默认添加，域名不能访问，--link可以打通连接

# 自定义一个网络
root@tom:/home/tom# docker network --help
Usage:  docker network COMMAND
Manage networks
Commands:
  connect     Connect a container to a network
  create      Create a network
  disconnect  Disconnect a container from a network
  inspect     Display detailed information on one or more networks
  ls          List networks
  prune       Remove all unused networks
  rm          Remove one or more networks
  
root@tom:/home/tom# docker network create --help
Usage:  docker network create [OPTIONS] NETWORK
Create a network
Options:
      --attachable           Enable manual container attachment
      --aux-address map      Auxiliary IPv4 or IPv6 addresses used by Network driver (default map[])
      --config-from string   The network from which to copy the configuration
      --config-only          Create a configuration only network
  -d, --driver string        Driver to manage the Network (default "bridge")
      --gateway strings      IPv4 or IPv6 Gateway for the master subnet
      --ingress              Create swarm routing-mesh network
      --internal             Restrict external access to the network
      --ip-range strings     Allocate container ip from a sub-range
      --ipam-driver string   IP Address Management Driver (default "default")
      --ipam-opt map         Set IPAM driver specific options (default map[])
      --ipv6                 Enable IPv6 networking
      --label list           Set metadata on a network
  -o, --opt map              Set driver specific options (default map[])
      --scope string         Control the network's scope
      --subnet strings       Subnet in CIDR format that represents a network segment

root@tom:/home/tom# docker network create --driver bridge --subnet 192.168.66.0/24 --gateway 192.168.66.1 mynet
ea7f98c69208084e0b516aeb515818439dbc2d21a9bf5e76a03aef65c866eaa0
root@tom:/home/tom# docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
483469c75d25   bridge    bridge    local
ef23768f459b   host      host      local
ea7f98c69208   mynet     bridge    local
20f6fa85d5be   none      null      local

root@tom:/home/tom# docker network inspect mynet
[
    {
        "Name": "mynet",
        "Id": "ea7f98c69208084e0b516aeb515818439dbc2d21a9bf5e76a03aef65c866eaa0",
        "Created": "2022-01-11T21:30:04.024616683+08:00",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": {},
            "Config": [
                {
                    "Subnet": "192.168.66.0/24",
                    "Gateway": "192.168.66.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {},
        "Options": {},
        "Labels": {}
    }
]
```

**测试**

```shell
root@tom:/home/tom# docker run -d -P --name net-01 --net mynet tomcat
e5384c44f89e018dac96723ba0284dc68d76f1fb0906b1bfd1b8f14ec3e3fbd5
root@tom:/home/tom# docker run -d -P --name net-02 --net mynet tomcat
fb9d1b64f1aafc3835d31ac21ed123fa1d1123c5122ce3899638513ef85bdfe8
```

![docker_net02](https://raw.githubusercontent.com/simoonp/picture/main/docker/docker_net02.png)

```shell
root@tom:/home/tom# docker exec -it net-01 ping 192.168.66.3
PING 192.168.66.3 (192.168.66.3) 56(84) bytes of data.
64 bytes from 192.168.66.3: icmp_seq=1 ttl=64 time=0.160 ms
64 bytes from 192.168.66.3: icmp_seq=2 ttl=64 time=0.069 ms
64 bytes from 192.168.66.3: icmp_seq=3 ttl=64 time=0.068 ms

root@tom:/home/tom# docker exec -it net-01 ping net-02
PING net-02 (192.168.66.3) 56(84) bytes of data.
64 bytes from net-02.mynet (192.168.66.3): icmp_seq=1 ttl=64 time=0.233 ms
64 bytes from net-02.mynet (192.168.66.3): icmp_seq=2 ttl=64 time=0.130 ms
```

自定义的网络，docker已经维护好了对应的关系

### 网络连通

![docker_net03](https://raw.githubusercontent.com/simoonp/picture/main/docker/docker_net03.png)

1、连接一个容器到一个网络

![docker_net05](https://raw.githubusercontent.com/simoonp/picture/main/docker/docker_net05.png)

```shell
# 创建 tomcat01 和 tomcat02
root@tom:/home/tom# docker run -d -P --name tomcat01 tomcat
e3548ab625cf207801ea183a96cc328ed06c1ca4e22ace5cea2cd8b8051befd0
root@tom:/home/tom# docker run -d -P --name tomcat02 tomcat
39baee6d0797470673f102327cf67eab216e8a802e172974924f7a78a9c40ebc

root@tom:/home/tom# docker network connect mynet tomcat01
root@tom:/home/tom# docker network inspect mynet
```

![docker_net04](https://raw.githubusercontent.com/simoonp/picture/main/docker/docker_net04.png)

将tomcat01添加到mynet——一个容器两个ip

```shell
root@tom:/home/tom# docker exec -it net-01 ping tomcat01
PING tomcat01 (192.168.66.4) 56(84) bytes of data.
64 bytes from tomcat01.mynet (192.168.66.4): icmp_seq=1 ttl=64 time=0.112 ms
64 bytes from tomcat01.mynet (192.168.66.4): icmp_seq=2 ttl=64 time=0.082 ms
```



## Docker小结

```shell
# 启动docker
systemctl start docker 

# 测试hello world
docker run hello-world

#查看已安装的镜像 
docker images 

# docker帮助命令
docker version 显示docker的版本信息
docker info    显示docker的系统信息，更详细 
docker 命令 --help

# 镜像搜索
docker search 镜像名字

# 镜像下载，没有 [:tag] 默认最新版
docker pull 镜像名字[:tag]

# 删除镜像
docker rmi -f 镜像id # 删除指定的镜像
docker rmi -f 镜像id1 镜像id2 镜像id3 # 删除多个镜像
docker rmi -f $(docker images -aq) #删除全部指令，$(docker images -aq)可以搜索全部镜像的id

# 启动镜像
docker run [可选参数] imagesid
    --name="Name"   建立的容器的名字，用来区分容器
    -d              后台运行方式
    -it             使用交互方式运行，进入容器查看内容
    -p              指定容器的端口 -p 8080:8080
        -p 主机端口：容器端口
        -p 容器端口
        容器端口
        -p ip:主机端口:容器端口
    -P              随机指定端口

# 列出所有运行的容器
docker ps
        # 列出当前正在运行的容器
    -a  # 列出当前正在运行的容器+历史运行过的容器
    -n=?    #显示最近创建的？个容器
    -q  # 只显示容器的编号

# 退出容器
exit    # 直接停止容器并退出
Ctrl+P+Q    #容器不停止，退出

# 删除容器
docker rm 容器id    # 删除指定容器，不能删除正在运行的容器，强制删除 -f
docker rm $(docker ps -aq)  # 删除所有容器
docker ps -a -q|xargs docker rm # 删除所有容器

# 启动和停止容器
docker start 容器id     # 启动
docker restart 容器id   # 重启
docker stop 容器id      # 停止
docker kill 容器id      # 强制停止容器

# 后台启动容器
docker run -d 镜像名

# 查看日志
docker logs -f -t --tail 日志数量 容器id 
    -t  #显示日志
    -f  #显示时间戳
    --tail number   # 显示日志条数

# 查看容器中进程的信息
docker top 容器id

# 查看镜像的源数据
docker inspect 容器id

# 进入正在运行的容器
# 启动新进程
docker exec -it 容器id bashShell
# 不启动新进程
docker attach 容器id

# 从容器拷贝文件到主机
docker cp 容器id:容器内文件的路径 主机文件夹路径

# 可视化工具 portainer
docker run -d -p 8088:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock --privileged=true portainer/portainer
# 在浏览器通过8080端口访问

# 将容器提交为镜像
docker commit -m="提交的描述信息" -a="作者名" 容器ID 目标镜像名:[tag]

# 挂载数据卷
# 直接挂载
docker run -it -v 主机目录绝对路径:容器目录绝对路径 容器id
# 匿名挂载 卷名是一长串字符
docker run -it -v 容器目录绝对路径 容器id
# 具名挂载，卷名保存在宿主机的/var/lib/docker/volumes/目录下，数据保存在对应卷名的_data目录下
docker run -it -v 卷名:容器内路径 容器id
# 通过 -v 容器内路径:ro/rw 改变读写权限
    ro  #只读，在容器内不能更改内容，只能从宿主机修改
    rw  #可读可写

# 容器之间实现数据共享，容器2会共用容器1的卷，即便容器1被删除
docker run -it --name 容器2 --volumes-from 容器1 镜像id

# DockerFile
构建过程
    1、构建 dockerfile 文件
    2、docker build 构建成为一个镜像
    3、docker run 运行镜像
    4、docker push 发布镜像（DockerHub、阿里云镜像仓库等）
# DockerFile指令
FROM		# 基础镜像，一切从这里开始
MAINTAINER	# 镜像是谁写的，姓名+邮箱
RUN			# 镜像构建是需要的命令
ADD			# 步骤：tomcat容器，这个tomcat压缩包，就是要添加的内容
WORKDIR		# 镜像的工作目录
VOLUME		# 挂载的目录
EXPOSE		# 指定暴漏的端口，端口配置
CMD			# 指定这个容器启动是要执行的指令，只有CMD的最后一个指令会生效
ENTRYPOINT	# 指定这个容器启动是要执行的指令，可以追加命令
ONBIUILD	# 当构建一个被继承的DockerFile，这是就会运行ONBUILD
COPY		# 类似ADD，将文件拷贝到镜像中
ENV			# 构建时设置环境变量

# 列出本地镜像的变更历史
docker history 镜像id

# 登录账号
docker login -u 用户名

# 给镜像增加标签
docker tag 镜像id 新镜像名:[tag] # 镜像名：用户名/名字

# push镜像，直接push会被拒绝
docker push 新镜像名:[tag]

# 容器2可以ping容器1，但容器1不能ping容器2
docker exec -it 容器2 --link 容器1 镜像id

# 查看所有 docker 网络
docker network ls

# docker的网络模式
    bridge：桥接（m默认）
    none：不配置网络
    host：和宿主机共享网络
    container：容器间联通（用的少，局限大）

# 自定义一个网络
docker network create --driver 网络模式 --subnet 1子网/划分方法 --gateway 网关地址 网络名
# docker network create --driver bridge --subnet 192.168.66.0/24 --gateway 192.168.66.1 mynet

# --net 指定容器连接某个网络；不指定的情况下，默认加了 --net bridge
docker run -d -P --name 容器名 --net 网络名 镜像id

# 将容器添加到指定网络
docker network connect 网络名 容器名
```

