# docker配置GPU

https://github.com/iot-salzburg/gpu-jupyter 

```shell
docker pull cschranz/gpu-jupyter:v1.4_cuda-11.0_ubuntu-18.04_slim

docker run --name=mm -d  \
--gpus all -it -p 8848:8888 -v $(pwd)/data:/home/jovyan/work \
-e GRANT_SUDO=yes -e JUPYTER_ENABLE_LAB=yes --user root \
cschranz/gpu-jupyter:v1.4_cuda-11.0_ubuntu-18.04_slim
# 密码 gpu-jupyter
```

测试

```python
import tensorflow as tf
import os
os.environ['TF_CPP_MIN_LOG_LEVEL']='2'
a = tf.constant(1.)
b = tf.constant(2.)
print(a+b)
print('GPU:', tf.test.is_gpu_available())
```

待整理

```shell
docker run --name tensorflow-serving -v /home/robot/docker/serving/serving/tensorflow_serving/servables/tensorflow/testdata/saved_model_half_plus_two_cpu/00000123:/bitnami/model-data bitnami/tensorflow-serving


docker run -it --rm \
--name=mm \
--device /dev/nvidia0:/dev/nvidia0  \
--device /dev/nvidiactl:/dev/nvidiactl \
--device /dev/nvidia-uvm:/dev/nvidia-uvm \
--device /dev/nvidia-uvm-tools:/dev/nvidia-uvm-tools \
--device /dev/nvidia-modeset:/dev/nvidia-modeset \
-v /usr/bin:/usr/bin \
-v /usr/lib:/usr/lib \
-p 10000:8888 jupyter/tensorflow-notebook

docker run -it --rm --name=mm -e GRANT_SUDO=yes -p  10000:8888 jupyter/tensorflow-notebook


docker run -it --rm \
--name=mm \
--device /dev/nvidia-uvm:/dev/nvidia-uvm:rwm \
--device /dev/nvidia-uvm-tools:/dev/nvidia-uvm-tools:rwm \
--device /dev/nvidia0:/dev/nvidia0:rwm \
--device /dev/nvidiactl:/dev/nvidiactl:rwm \
-v /usr/bin/nvidia-smi:/usr/bin/nvidia-smi:ro \
-v /usr/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:ro \
-p 10000:8888 jupyter/tensorflow-notebook



docker pull pbatey/jupyter-tensorflow-notebook-gpudocker run --name tensorflow-serving -v /home/robot/docker/serving/serving/tensorflow_serving/servables/tensorflow/testdata/saved_model_half_plus_two_cpu/00000123:/bitnami/model-data bitnami/tensorflow-serving


docker run -it --rm \
--name=mm \
--device /dev/nvidia0:/dev/nvidia0  \
--device /dev/nvidiactl:/dev/nvidiactl \
--device /dev/nvidia-uvm:/dev/nvidia-uvm \
--device /dev/nvidia-uvm-tools:/dev/nvidia-uvm-tools \
--device /dev/nvidia-modeset:/dev/nvidia-modeset \
-v /usr/bin:/usr/bin \
-v /usr/lib:/usr/lib \
-p 10000:8888 jupyter/tensorflow-notebook

docker run -it --rm --name=mm -e GRANT_SUDO=yes -p  10000:8888 jupyter/tensorflow-notebook


docker run -it --rm \
--name=mm \
--device /dev/nvidia-uvm:/dev/nvidia-uvm:rwm \
--device /dev/nvidia-uvm-tools:/dev/nvidia-uvm-tools:rwm \
--device /dev/nvidia0:/dev/nvidia0:rwm \
--device /dev/nvidiactl:/dev/nvidiactl:rwm \
-v /usr/bin/nvidia-smi:/usr/bin/nvidia-smi:ro \
-v /usr/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:ro \
-p 10000:8888 jupyter/tensorflow-notebook

sudo docker run --rm --gpus all nvidia/cuda:11.4.0-devel-ubuntu18.04 nvidia-smi

docker pull pbatey/jupyter-tensorflow-notebook-gpu

docker run --gpus all -d -it -p 8848:8888 -v $(pwd)/data:/home/jovyan/work -e GRANT_SUDO=yes -e JUPYTER_ENABLE_LAB=yes --user root cschranz/gpu-jupyter:v1.4_cuda-11.4_ubuntu-18.04_python-only

docker build -t gpu-jupyter .build/  # will take a while
docker run --gpus all -d -it -p 10000:8888 -v $(pwd)/data:/home/jovyan/work -e GRANT_SUDO=yes -e JUPYTER_ENABLE_LAB=yes -e NB_UID="$(id -u)" -e NB_GID="$(id -g)" --user root --name mm



docker run --gpus all -d -it -p 8848:8888 -v $(pwd)/data:/home/jovyan/work -e GRANT_SUDO=yes -e JUPYTER_ENABLE_LAB=yes --user root ba12ff42310f
```

# Ubuntu18安装Nvidia驱动

参考链接 https://www.cnblogs.com/pprp/p/9430836.html#5--%E8%8E%B7%E5%8F%96kernel-source-important 

![install_nvidia_driver](https://raw.githubusercontent.com/simoonp/upgit_picture/main/2022/09/upgit_20220917_1663383561.png)

链接中大部分步骤没有问题，这里针对容易出现错误的地方增加说明

在链接中的 `第8个步骤 挂载Nvidia驱动` 

执行`modprobe nvidia` 后报错 `modprobe: ERROR: could not insert 'nvidia': Operation not permitted`

解决方法：

进入BIOS，关闭 `安全启动模式`，运行`nvidia-smi`可以看到

```shell
Fri Sep 16 23:03:57 2022       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 470.141.03   Driver Version: 470.141.03   CUDA Version: 11.4     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA GeForce ...  Off  | 00000000:01:00.0 Off |                  N/A |
| N/A   51C    P0    32W /  N/A |      0MiB /  7973MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
```

`sudo systemctl set-default graphical.target ` 开启图形界面

*其他参考链接*：https://www.if-not-true-then-false.com/2021/debian-ubuntu-linux-mint-nvidia-guide/ 



